name: Marcar Asistencia Talana

on:
  repository_dispatch:
    types: [mark-attendance]
  workflow_dispatch:

jobs:
  mark-attendance:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout código
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Instalar dependencias
        run: npm install puppeteer
      
      - name: Marcar asistencia con reintentos
        id: mark
        continue-on-error: true
        run: |
          for attempt in 1 2 3; do
            echo "Intento $attempt de 3..."
            if node mark-attendance.js; then
              echo "success=true" >> $GITHUB_OUTPUT
              exit 0
            fi
            if [ $attempt -lt 3 ]; then
              echo "Fallo. Reintentando en 10 segundos..."
              sleep 10
            fi
          done
          echo "success=false" >> $GITHUB_OUTPUT
          exit 1
        env:
          TALANA_USER: ${{ secrets.TALANA_USER }}
          TALANA_PASS: ${{ secrets.TALANA_PASS }}
      
      - name: Notificar fallo
        if: steps.mark.outputs.success == 'false'
        run: |
          echo "::error::Fallo al marcar asistencia después de 3 intentos"
          exit 1
